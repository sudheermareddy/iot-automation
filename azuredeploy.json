{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adminUsername": {
            "type": "string",
            "defaultValue": "adminuser",
            "metadata": {
                "description": "Username for all the Virtual Machines."
            }
        },
        "adminPassword": {
            "type": "securestring",
            "defaultValue": "Password@1234",
            "metadata": {
                "description": "Password for all the Virtual Machines."
            }
        },
        "domainName": {
            "type": "string",
            "defaultValue": "sysgainiot.com",
            "metadata": {
                "description": "The FQDN of the Active Directory Domain to be created on VM"
            }
        }
    },
    "variables": {
        "apiVersions": {
            "computeApiVersion": "2016-04-30-preview",
            "networkApiVersion": "2016-09-01",
            "storageApiVersion": "2016-01-01",
            "deploymentApiVersion": "2016-02-01",
            "sqlServerApiVersion": "2015-05-01-preview",
            "sqlDBApiVersion": "2014-04-01-preview"
        },
        "networkSettings": {
            "location": "[resourceGroup().location]",
            "networkApiVersion": "2016-03-30",
            "virtualNetworkName": "MyVNET",
            "addressPrefix": "10.0.0.0/16",
            "subnet1Name": "subnet1",
            "subnet1Prefix": "10.0.0.0/24",
            "subnet2Name": "subnet2",
            "subnet2Prefix": "10.0.1.0/24",
            "subnet3Name": "subnet3",
            "subnet3Prefix": "10.0.2.0/24",
            "subnet4Name": "subnet4",
            "subnet4Prefix": "10.0.3.0/24",
            "subnet5Name": "subnet5",
            "subnet5Prefix": "10.0.4.0/24",
            "subnet6Name": "subnet6",
            "subnet6Prefix": "10.0.5.0/24"
        },
        "bastionServerSettings": {
            "location": "[resourceGroup().location]",
            "bastionVMName": "bastionServer",
            "adminUsername": "[parameters('adminUsername')]",
            "adminPassword": "[parameters('adminPassword')]",
            "bastionNic": "bastion-nic",
            "bastionDiagStgAcnt": "[concat('bastionstrg',variables('suffix'))]",
            "bastionVMSize": "Standard_DS1_v2",
            "publisher": "MicrosoftWindowsServer",
            "offer": "WindowsServer",
            "sku": "2012-R2-Datacenter",
            "version": "latest",
            "storageAccountType": "[variables('storageAccountType')]",
            "diagStorageAccountType": "Standard_LRS",
            "publicIpAddressName": "bastion-pip",
            "networkSecurityGroupName": "bastion-nsg",
            "publicIpAddressType": "Dynamic",
            "bastionDnsLabelPrefix": "[concat('bastionserver',variables('suffix'))]",
            "fileUris": "[concat(variables('baseUrl'),'scripts/psscript.ps1')]",
            "scriptFileName": "psscript.ps1",
            "domainName": "[parameters('domainName')]",
            "Username": "[parameters('adminUsername')]",
            "Password": "[parameters('adminPassword')]",
            "TenantIdentifier": "NA",
            "TenantActivationPassword": "NA",
            "ActivationPort": "[variables('MCSModules').heartbeatPortTrendDSM]",
            "ManagerAddress": "[concat(variables('MCSModules').publicIPDomainNameLabelTrendDSM,'.',resourceGroup().location,'.cloudapp.azure.com')]"
        },
        "MCSModules": {
            "location": "[resourceGroup().location]",
            "adNicName": "adNic",
            "splunkNicName": "splunkNic",
            "splunkNsg": "splunkNsg",
            "adNicIPAddress": "10.0.2.4",
            "splunkIPAddress": "10.0.2.5",
            "chefAutomateIPAddress": "10.0.2.6",
            "wsIPAddress": "10.0.2.7",
            "sshFrom": "0.0.0.0/0",
            "forwardedDataFrom": "0.0.0.0/0",
            "adVMName": "adServer",
            "splunkVMName": "splunkServer",
            "splunkExtensionName": "splunkExtension",
            "typeHandlerVersion": "1.5",
            "splunkImagePublisher": "splunk",
            "splunkImageOffer": "splunk-enterprise-base-image",
            "splunkImageSKU": "splunk-on-ubuntu-14-04-lts",
            "splunkImageVersion": "1.1.1",
            "Username": "[parameters('adminUsername')]",
            "Password": "[parameters('adminPassword')]",
            "domainName": "[parameters('domainName')]",
            "adExtensionName": "CreateADForest",
            "wsNsg": "ws-client-nsg",
            "chefAutoNsg": "chefauto-nsg",
            "wsNic": "ws-client-nic",
            "chefAutoNic": "chefauto-nic",
            "wsClientDns": "[concat('wsclient',substring(variables('prefix') ,0 ,5))]",
            "chefAutoDns": "[concat('chefauto',substring(variables('prefix') ,0 ,5))]",
            "scriptFileName": "psscript.ps1",
            "dnsPrefix": "[concat('adserver',variables('suffix'))]",
            "publisher": "MicrosoftWindowsServer",
            "offer": "WindowsServer",
            "sku": "2016-Datacenter",
            "version": "latest",
            "chefImagePublisher": "chef-software",
            "chefImageOffer": "chef-automate",
            "chefImageSKU": "byol",
            "chefImageVersion": "latest",
            "wsVmName": "chefworkstation",
            "chefAutoVmName": "chefautomate",
            "firstname": "chefautomate",
            "lastname": "user",
            "orguser": "orguser",
            "mailid": "orguser@gmail.com",
            "rubyPath": "/opt/chef-marketplace/embedded/bin/ruby",
            "VMSize": "Standard_DS2_v2",
            "automateLicenseUri": "",
            "storageAccountType": "Premium_LRS",
            "adNetworkSecurityGroupName": "adnsg",
            "adstorageAccountName": "[concat('adstrg',variables('suffix'))]",
            "diskCreateOption": "empty",
            "diskSizeGB": "1023",
            "trendPublisher": "trendmicro",
            "trendVMSize": "Standard_D2_v2",
            "trendVMSku": "dxxn25d2v2",
            "trendProduct": "deep-security-vm",
            "vmNameTrendDSM": "trendMicroDSM",
            "nicNameTrendDSM": "trendnic",
            "securityGroupNameTrendDSM": "trendnsg",
            "publicIPDomainNameLabelTrendDSM": "[concat('publicdnstrenddsm',variables('suffix'))]",
            "managerPortTrendDSM": "443",
            "heartbeatPortTrendDSM": "4120",
            "vmAdminNameTrendDSM": "trend",
            "publicIPAddressNameTrendDSM": "publicIPTrendDSM",
            "vmAdminPasswordTrendDSM": "[parameters('adminPassword')]",
            "dbAdminName": "trend",
            "dbAdminPassword": "[parameters('adminPassword')]",
            "dsmAdminName": "trend",
            "dsmAdminPassword": "[parameters('adminPassword')]",
            "dbName": "dsm",
            "databaseOption": "new",
            "licenseMode": "10",
            "newsqlServerName": "[tolower(concat('trend',uniquestring(resourceGroup().id),'-sql'))]",
            "azuresqlUrl": "[concat(variables('baseUrl'),'/nested/database-new.json')]",
            "fileUris": "[concat(variables('baseUrl'),'scripts/psscript.ps1')]",
            "commandToExecute": "[concat('bash node-setup.sh', ' -r ', variables('splunkServerRole'), ' -p ', parameters('adminPassword'))]",
            "splunkScriptsUrl": "[concat(variables('baseUrl'),'scripts/node-setup.sh')]",
            "dscScriptUrl": "[variables('dscScriptUrl')]",
            "updateVnetDnsUrl": "[concat(variables('baseUrl'), 'nested/vnetdns.json')]",
            "chefAutoScriptUrl1": "[concat(variables('baseUrl'),'scripts/automate_setup.rb')]",
            "workstationSetup": "[concat(variables('baseUrl'),'scripts/workstationsetup1.ps1')]",
            "workstationextensionurl": "[concat(variables('baseUrl'),'nested/workstation-extension.json')]",
            "workstationSetupUrl2": "[concat(variables('baseUrl'),'scripts/workstationsetup2.ps1')]",
            "domainJoinUrl": "[concat(variables('baseUrl'),'nested/domainjoin.json')]"
        },
        "splunkServerRole": "splunk_server",
        "storageAccountType": "Premium_LRS",
        "baseUrl": "https://raw.githubusercontent.com/sysgain/iot-automation/staging/",
        "dscScriptUrl": "https://github.com/sysgain/iot-automation/raw/staging",
        "prefix": "[uniqueString(resourceGroup().id)]",
        "deploymentApiVersion": "2016-02-01",
        "suffix": "[substring(uniqueString(resourceGroup().id), 0, 5)]"
    },
    "resources": [
        {
            "type": "Microsoft.Network/virtualNetworks",
            "name": "[variables('networkSettings').virtualNetworkName]",
            "apiVersion": "[variables('apiVersions').networkApiVersion]",
            "location": "[variables('networkSettings').location]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[variables('networkSettings').addressPrefix]"
                    ]
                },
                "subnets": [
                    {
                        "name": "[variables('networkSettings').subnet1Name]",
                        "properties": {
                            "addressPrefix": "[variables('networkSettings').subnet1Prefix]"
                        }
                    },
                    {
                        "name": "[variables('networkSettings').subnet2Name]",
                        "properties": {
                            "addressPrefix": "[variables('networkSettings').subnet2Prefix]"
                        }
                    },
                    {
                        "name": "[variables('networkSettings').subnet3Name]",
                        "properties": {
                            "addressPrefix": "[variables('networkSettings').subnet3Prefix]"
                        }
                    },
                    {
                        "name": "[variables('networkSettings').subnet4Name]",
                        "properties": {
                            "addressPrefix": "[variables('networkSettings').subnet4Prefix]"
                        }
                    },
                    {
                        "name": "[variables('networkSettings').subnet5Name]",
                        "properties": {
                            "addressPrefix": "[variables('networkSettings').subnet5Prefix]"
                        }
                    },
                    {
                        "name": "[variables('networkSettings').subnet6Name]",
                        "properties": {
                            "addressPrefix": "[variables('networkSettings').subnet6Prefix]"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "MCSModules",
            "apiVersion": "[variables('deploymentApiVersion')]",
            "dependsOn": [
                "[concat('Microsoft.Network/virtualNetworks/',variables('networkSettings').virtualNetworkName)]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('baseUrl'), 'nested/mcs.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "MCSModules": {
                        "value": "[variables('MCSModules')]"
                    },
                    "networkSettings": {
                        "value": "[variables('networkSettings')]"
                    },
                    "apiVersions": {
                        "value": "[variables('apiVersions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "BastionHost",
            "apiVersion": "[variables('deploymentApiVersion')]",
            "dependsOn": [
                "MCSModules"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('baseUrl'), 'nested/bastionServer.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "bastionServerSettings": {
                        "value": "[variables('bastionServerSettings')]"
                    },
                    "networkSettings": {
                        "value": "[variables('networkSettings')]"
                    },
                    "apiVersions": {
                        "value": "[variables('apiVersions')]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "adminUsername": {
            "type": "string",
            "value": "[parameters('adminUserName')]"
        },
        "adminPassword": {
            "type": "string",
            "value": "[parameters('adminPassword')]"
        },
        "bastionFQDN": {
            "type": "string",
            "value": "[reference('BastionHost').outputs.bastionFQDN.value]"
        },
        "adServerIP": {
            "type": "string",
            "value": "[variables('MCSModules').adNicIPAddress]"
        }
    }
}